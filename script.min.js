function detectFaceAndFeatures(){let t=ctx.getImageData(0,0,canvas.width,canvas.height),e=t.data,l=detectSkin(e,canvas.width,canvas.height),n=detectFaceContours(l,canvas.width,canvas.height);for(let o of n){let{minX:r,minY:_,maxX:i,maxY:$}=getContourBounds(o),f=detectEyes(o,e,canvas.width,canvas.height),u=detectEyebrows(o,e,canvas.width,canvas.height),h=detectEars(o,e,canvas.width,canvas.height),c=detectNose(o,e,canvas.width,canvas.height,f),d=detectMouth(o,e,canvas.width,canvas.height),s=[f.length>=2,u.length>=2,c,d,h.length>=2].filter(Boolean).length;s>=2&&drawBoundingBox(r,_,i,$)}}function detectSkin(t,e,l){let n=Array(e*l).fill(!1);for(let o=0;o<t.length;o+=4){let r=t[o],_=t[o+1],i=t[o+2],$=128-.168736*r-.331264*_+.5*i,f=128+.5*r-.418688*_-.081312*i,u=$>=77&&$<=127&&f>=133&&f<=173,h=r>95&&_>40&&i>20&&r>_&&r>i&&Math.abs(r-_)>15;u&&h&&(n[o/4]=!0)}return applyMorphologicalOperations(n,e,l)}function applyMorphologicalOperations(t,e,l){let n=Array(e*l).fill(!1);for(let o=1;o<l-1;o++)for(let r=1;r<e-1;r++){let _=o*e+r;if(t[_])for(let i=-1;i<=1;i++)for(let $=-1;$<=1;$++){let f=(o+i)*e+(r+$);n[f]=!0}}let u=Array(e*l).fill(!1);for(let h=1;h<l-1;h++)for(let c=1;c<e-1;c++){let d=h*e+c;if(n[d]){let s=!0;for(let g=-1;g<=1;g++){for(let a=-1;a<=1;a++){let p=(h+g)*e+(c+a);if(!n[p]){s=!1;break}}if(!s)break}s&&(u[d]=!0)}}return u}function detectFaceContours(t,e,l){let n=[],o=Array(e*l).fill(!1);for(let r=0;r<l;r++)for(let _=0;_<e;_++){let i=r*e+_;if(t[i]&&!o[i]){let $=[];floodFill(_,r,t,e,l,o,$),$.length>100&&n.push($)}}return n}function detectEyes(t,e,l,n){let o=[],r=[];for(let[_,i]of t){let $=i*l+_,f=e[4*$],u=e[4*$+1],h=e[4*$+2];f>220&&u>220&&h>220&&r.push([_,i])}let c=[];for(let[d,s]of t){let g=s*l+d,a=e[4*g],p=e[4*g+1],w=e[4*g+2];a<30&&p<30&&w<30&&c.push([d,s])}let E=detectEllipses(r,l,n);for(let y of E){let{centerX:b,centerY:k,radiusX:x,radiusY:B}=y,C=!1;for(let[F,R]of c){let m=(F-b)/x,S=(R-k)/B;if(m*m+S*S<=1){C=!0;break}}C&&o.push([b,k,x,B])}return o.sort((t,e)=>t[0]-e[0]),o}function detectEllipses(t,e,l){let n=[];for(let o=0;o<t.length;o++){let[r,_]=t[o];n.push({centerX:r,centerY:_,radiusX:20,radiusY:10})}return n}function detectEyebrows(t,e,l,n,o,r=20,_=30,i=50){let $=[];if(t.length<2)return $;let f=t[0],u=t[1],h=detectEyebrowInRegion(f[0],f[1]-r,l,n,o,_,r,i);h&&$.push(...h);let c=detectEyebrowInRegion(u[0],u[1]-r,l,n,o,_,r,i);return c&&$.push(...c),$}function detectEyebrowInRegion(t,e,l,n,o,r,_,i){let $=[];for(let f=e;f<e+_;f++)for(let u=t-r/2;u<t+r/2;u++)if(u>=0&&u<n&&f>=0&&f<o){let h=f*n+u;l[4*h]<i&&l[4*h+1]<i&&l[4*h+2]<i&&$.push([u,f])}return $.length>0?$:null}function detectEdges(t,e,l,n){let o=new Uint8Array(e*l);for(let r=1;r<l-1;r++)for(let _=1;_<e-1;_++){let i=r*e+_,$=t[(r-1)*e+(_+1)]-t[(r-1)*e+(_-1)]+2*(t[r*e+(_+1)]-t[r*e+(_-1)])+(t[(r+1)*e+(_+1)]-t[(r+1)*e+(_-1)]),f=t[(r+1)*e+(_-1)]-t[(r-1)*e+(_-1)]+2*(t[(r+1)*e+_]-t[(r-1)*e+_])+(t[(r+1)*e+(_+1)]-t[(r-1)*e+(_+1)]),u=Math.sqrt($*$+f*f);o[i]=u>n?255:0}return o}function findContours(t,e,l){let n=[],o=new Uint8Array(e*l);function r(n,r,_){let i=[[n,r]];for(;i.length;){let[$,f]=i.pop(),u=f*e+$;!($<0)&&!(f<0)&&!($>=e)&&!(f>=l)&&0!==t[u]&&!o[u]&&(o[u]=1,_.push([$,f]),i.push([$+1,f],[$-1,f],[$,f+1],[$,f-1]))}}for(let _=0;_<l;_++)for(let i=0;i<e;i++){let $=_*e+i;if(t[$]&&!o[$]){let f=[];r(i,_,f),n.push(f)}}return n}function detectEars(t,e,l,n,o=100,r=100){let _=[],i=new Uint8Array(l*n);for(let $=0;$<e.length;$+=4)i[$/4]=.299*e[$]+.587*e[$+1]+.114*e[$+2];let f=detectEdges(i,l,n,r),u=findContours(f,l,n);u.sort((t,e)=>e.length-t.length);for(let h=0;h<u.length;h++){let c=getBoundingRect(u[h]),d=c.width/c.height;if(d>.5&&d<1.5){let[s,g,a,p]=[c.x,c.y,c.width,c.height],w=g*l+s;if(e[4*w]>o&&e[4*w+1]>o&&e[4*w+2]>o&&(_.push([s,g]),2===_.length))break}}return _}function getBoundingRect(t){let e=1/0,l=1/0,n=-1/0,o=-1/0;return t.forEach(([t,r])=>{t<e&&(e=t),t>n&&(n=t),r<l&&(l=r),r>o&&(o=r)}),{x:e,y:l,width:n-e,height:o-l}}function detectNose(t,e,l,n,o,r=100,_=80,i=100,$=100){if(o.length<2)return null;let[f,u]=o,h=(f[0]+u[0])/2,c=(f[1]+u[1])/2,d=Math.max(h-r/2,0),s=Math.min(h+r/2,l),g=Math.max(c+20,0),a=Math.min(c+_,n),p=[];for(let w=g;w<a;w++)for(let E=d;E<s;E++){let y=w*l+E;isSkinPixel(e[4*y],e[4*y+1],e[4*y+2],i)&&p.push([E,w])}let b=null,k=0;for(let[x,B]of p){let C=0;for(let F=-2;F<=2;F++)for(let R=-2;R<=2;R++){let m=x+R,S=B+F,I=S*l+m;if(m>=0&&m<l&&S>=0&&S<n){let M=e[4*I],N=e[4*I+1],O=e[4*I+2];M<$&&N<$&&O<$&&C++}}C>k&&(k=C,b=[x,B])}return b}function isSkinPixel(t,e,l,n){return t>n&&e>n&&l>n}function detectMouth(t,e,l,n){for(let[o,r]of t){let _=r*l+o;if(e[4*_]>100&&e[4*_+1]<50&&e[4*_+2]<50)return[o,r]}return null}function getContourBounds(t){let e=1/0,l=1/0,n=-1/0,o=-1/0;for(let[r,_]of t)r<e&&(e=r),_<l&&(l=_),r>n&&(n=r),_>o&&(o=_);return{minX:e,minY:l,maxX:n,maxY:o}}function drawBoundingBox(t,e,l,n){ctx.strokeStyle="blue",ctx.lineWidth=2,ctx.strokeRect(t,e,l-t,n-e)}function floodFill(t,e,l,n,o,r,_){let i=[[t,e]];for(;i.length>0;){let[$,f]=i.pop(),u=f*n+$;!($<0)&&!($>=n)&&!(f<0)&&!(f>=o)&&!r[u]&&l[u]&&(r[u]=!0,_.push([$,f]),i.push([$+1,f],[$-1,f],[$,f+1],[$,f-1]))}}